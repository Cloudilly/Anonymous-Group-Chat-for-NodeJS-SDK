var WebSocket=require("ws");module.exports={initialize:function(t,e,a){this.app=t,this.access=e,this.socket={},this.tasks={},this.callbacks={},this.pings={},this.attempts=0,this.username="",this.password="",a()},connect:function(t,e){var a=this;(!a.socket||0!=a.socket.readyState&&1!=a.socket.readyState)&&(a.username=t,a.password=e,a.socket=new WebSocket("wss://ws.cloudilly.com"),a.socket.onopen=function(){a.attempts=0,a.connectNormal.call(a)},a.socket.onmessage=function(t){if("1"!=t.data){var e=JSON.parse(t.data);switch(e.type){case"connect":switch(e.status){case"success":return void a.connectSuccess.call(a,e);case"fail":return void a.connectFail.call(a,e)}return;case"task":switch(e.status){case"success":return void a.taskSuccess.call(a,e);case"fail":return void a.taskFail.call(a,e)}return;case"device":return void a.callbacks.device.call(a,e);case"post":return void a.callbacks.post.call(a,e)}}},a.socket.onerror=function(t){return a.attempts=a.attempts+1,clearTimeout(a.pings),a.callbacks.disconnected.call(a),4e3==t.code||a.attempts>100?void(a.attempts=0):void setTimeout(function(){a.connect.call(a,a.username,a.password)},2e3*a.attempts)},a.socket.onclose=function(t){return a.attempts=a.attempts+1,clearTimeout(a.pings),a.callbacks.disconnected.call(a),4e3==t.code||a.attempts>100?void(a.attempts=0):void setTimeout(function(){a.connect.call(a,a.username,a.password)},2e3*a.attempts)})},disconnect:function(){var t=this,e={};e.type="disconnect";var a=JSON.stringify(e);t.socket.send(a)},listen:function(t,e){var a=this,s={};s.type="listen",s.group=t,a.writeAndTask.call(a,s,e)},listenWithPassword:function(t,e,a){var s=this,n={};n.type="listen",n.group=t,n.password=e,s.writeAndTask.call(s,n,a)},unlisten:function(t,e){var a=this,s={};s.type="unlisten",s.group=t,a.writeAndTask.call(a,s,e)},join:function(t,e){var a=this,s={};s.type="join",s.group=t,a.writeAndTask.call(a,s,e)},joinWithPassword:function(t,e,a){var s=this,n={};n.type="join",n.group=t,n.password=e,s.writeAndTask.call(s,n,a)},unjoin:function(t,e){var a=this,s={};s.type="unjoin",s.group=t,a.writeAndTask.call(a,s,e)},update:function(t,e){var a=this,s={};s.type="update",s.payload=t,a.writeAndTask.call(a,s,e)},post:function(t,e,a){var s=this,n={};n.type="post",n.group=t,n.payload=e,s.writeAndTask.call(s,n,a)},store:function(t,e,a){var s=this,n={};n.type="store",n.group=t,n.payload=e,s.writeAndTask.call(s,n,a)},remove:function(t,e){var a=this,s={};s.type="remove",s.post=t,a.writeAndTask.call(a,s,e)},create:function(t,e,a){var s=this,n={};n.type="create",n.group=t,n.password=e,s.writeAndTask.call(s,n,a)},login:function(t,e,a){var s=this;s.username=t,s.password=e;var n={};n.type="login",n.username=s.username,n.password=s.password,s.writeAndTask.call(s,n,a)},logout:function(t){var e=this;delete e.username,delete e.password;var a={};a.type="logout",e.writeAndTask.call(e,a,t)},link:function(t,e){var a=this,s={};s.type="link",s.group=t,a.writeAndTask.call(a,s,e)},unlink:function(t,e){var a=this,s={};s.type="unlink",s.group=t,a.writeAndTask.call(a,s,e)},notify:function(t,e,a){var s=this,n={};n.type="notify",n.message=t,n.group=e,s.writeAndTask.call(s,n,a)},email:function(t,e,a,s){var n=this,c={};c.type="email",c.recipient=t,c.subject=e,c.body=a,n.writeAndTask.call(n,c,s)},requestPasswordChange:function(t,e){var a=this,s={};s.type="requestPasswordChange",s.group=t,a.writeAndTask.call(a,s,e)},changePassword:function(t,e,a,s){var n=this,c={};c.type="changePassword",c.group=t,c.password=e,c.token=a,n.writeAndTask.call(n,c,s)},_verifyAccount:function(t,e,a){var s=this,n={};n.type="_verifyAccount",n.username=t,n.accountID=e,s.writeAndTask.call(s,n,a)},_updateAPNSPlatform:function(t,e,a,s,n){var c=this,i={};i.type="_updateAPNSPlatform",i.app=t,i.device=e,i.platform=a,i.arn=s,c.writeAndTask.call(c,i,n)},_updateGCMPlatform:function(t,e,a,s,n){var c=this,i={};i.type="_updateGCMPlatform",i.app=t,i.device=e,i.arn=a,i.serverkey=s,c.writeAndTask.call(c,i,n)},_updatePlan:function(t,e,a){var s=this,n={};n.type="_updatePlan",n.app=t,n.plan=e,s.writeAndTask.call(s,n,a)},_cleanDevices:function(t,e){var a=this,s={};s.type="_cleanDevices",s.host=t,a.writeAndTask.call(a,s,e)},connectNormal:function(){var t=this;if(t.socket&&1==t.socket.readyState){var e={};e.type="connect",e.app=t.app,e.access=t.access,e.saas="hook",e.version=1,t.username&&(e.username=t.username),t.password&&(e.password=t.password);var a=JSON.stringify(e);t.socket.send(a)}},connectSuccess:function(t){var e=this;e.startPing.call(e),e.callbacks.connected.call(e,null,t)},connectFail:function(t){var e=this;e.callbacks.connected.call(e,1,t)},taskSuccess:function(t){var e=this;e.callbacks[t.task].call(e,null,t),delete e.callbacks[t.task],delete e.tasks[t.task]},taskFail:function(t){var e=this;e.callbacks[t.task].call(e,1,t),delete e.callbacks[t.task],delete e.tasks[t.task]},startPing:function(){var t=this;t.firePing.call(t),t.pings=setInterval(function(){t.firePing.call(t)},15e3)},firePing:function(){var t=this;if(t.socket&&1==t.socket.readyState){t.socket.send("1");var e=[];for(var a in t.tasks)e.push([a,t.tasks[a].timestamp]);e.sort(function(t,e){return t[1]<e[1]?1:t[1]>e[1]?-1:0});for(var s=e.length;s--;){var n=t.tasks[e[s][0]];t.socket.send(n.data)}}},writeAndTask:function(t,e){var a=this;if(a.socket&&1==a.socket.readyState){var s=Math.round((new Date).getTime()),n=t.type+"-"+a.generateUUID.call();t.task=n,a.callbacks[n]=e;var c={};c.timestamp=s,c.data=JSON.stringify(t),c.task=n,a.tasks[n]=c;var i=JSON.stringify(t);a.socket.send(i)}},generateUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,a="x"===t?e:3&e|8;return a.toString(16)})},socketConnected:function(t){this.callbacks.connected=t},socketDisconnected:function(t){this.callbacks.disconnected=t},socketReceivedDevice:function(t){this.callbacks.device=t},socketReceivedPost:function(t){this.callbacks.post=t}};