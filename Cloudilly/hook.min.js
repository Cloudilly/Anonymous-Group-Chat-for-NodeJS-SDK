var WebSocket=require("ws");module.exports={initialize:function(t,e,s){this.app=t,this.access=e,this.socket={},this.tasks={},this.callbacks={},this.ping={},this.pong={},this.attempts=0,this.username="",this.password="",s()},connect:function(t,e){var s=this;(!s.socket||0!=s.socket.readyState&&1!=s.socket.readyState)&&(s.username=t,s.password=e,s.socket=new WebSocket("wss://ws.cloudilly.com"),s.socket.onopen=function(){s.attempts=0,s.connectNormal.call(s)},s.socket.onmessage=function(t){if("1"==t.data)return void s.stopPong.call(s);var e=JSON.parse(t.data);switch(e.type){case"connect":switch(e.status){case"success":return void s.connectSuccess.call(s,e);case"fail":return void s.connectFail.call(s,e)}return;case"task":switch(e.status){case"success":return void s.taskSuccess.call(s,e);case"fail":return void s.taskFail.call(s,e)}return;case"device":return void s.callbacks.device.call(s,e);case"post":return void s.callbacks.post.call(s,e)}},s.socket.onerror=function(t){return s.attempts=s.attempts+1,clearTimeout(s.ping),s.callbacks.disconnected.call(s),4e3==t.code||s.attempts>100?void(s.attempts=0):void setTimeout(function(){s.connect.call(s,s.username,s.password)},2e3*s.attempts)},s.socket.onclose=function(t){return s.attempts=s.attempts+1,clearTimeout(s.ping),s.callbacks.disconnected.call(s),4e3==t.code||s.attempts>100?void(s.attempts=0):void setTimeout(function(){s.connect.call(s,s.username,s.password)},2e3*s.attempts)})},disconnect:function(){var t=this,e={};e.type="disconnect";var s=JSON.stringify(e);t.socket.send(s)},listen:function(t,e){var s=this,a={};a.type="listen",a.group=t,s.writeAndTask.call(s,a,e)},listenWithPassword:function(t,e,s){var a=this,n={};n.type="listen",n.group=t,n.password=e,a.writeAndTask.call(a,n,s)},unlisten:function(t,e){var s=this,a={};a.type="unlisten",a.group=t,s.writeAndTask.call(s,a,e)},join:function(t,e){var s=this,a={};a.type="join",a.group=t,s.writeAndTask.call(s,a,e)},joinWithPassword:function(t,e,s){var a=this,n={};n.type="join",n.group=t,n.password=e,a.writeAndTask.call(a,n,s)},unjoin:function(t,e){var s=this,a={};a.type="unjoin",a.group=t,s.writeAndTask.call(s,a,e)},update:function(t,e){var s=this,a={};a.type="update",a.payload=t,s.writeAndTask.call(s,a,e)},post:function(t,e,s){var a=this,n={};n.type="post",n.group=t,n.payload=e,a.writeAndTask.call(a,n,s)},store:function(t,e,s){var a=this,n={};n.type="store",n.group=t,n.payload=e,a.writeAndTask.call(a,n,s)},remove:function(t,e){var s=this,a={};a.type="remove",a.post=t,s.writeAndTask.call(s,a,e)},create:function(t,e,s){var a=this,n={};n.type="create",n.group=t,n.password=e,a.writeAndTask.call(a,n,s)},login:function(t,e,s){var a=this;a.username=t,a.password=e;var n={};n.type="login",n.username=a.username,n.password=a.password,a.writeAndTask.call(a,n,s)},logout:function(t){var e=this;delete e.username,delete e.password;var s={};s.type="logout",e.writeAndTask.call(e,s,t)},link:function(t,e){var s=this,a={};a.type="link",a.group=t,s.writeAndTask.call(s,a,e)},unlink:function(t,e){var s=this,a={};a.type="unlink",a.group=t,s.writeAndTask.call(s,a,e)},notify:function(t,e,s){var a=this,n={};n.type="notify",n.message=t,n.group=e,a.writeAndTask.call(a,n,s)},email:function(t,e,s,a){var n=this,c={};c.type="email",c.recipient=t,c.subject=e,c.body=s,n.writeAndTask.call(n,c,a)},requestPasswordChange:function(t,e){var s=this,a={};a.type="requestPasswordChange",a.group=t,s.writeAndTask.call(s,a,e)},changePassword:function(t,e,s,a){var n=this,c={};c.type="changePassword",c.group=t,c.password=e,c.token=s,n.writeAndTask.call(n,c,a)},connectNormal:function(t,e){var s=this;if(s.socket&&1==s.socket.readyState){var a={};a.type="connect",a.app=s.app,a.access=s.access,a.saas="hook",a.version=1,s.username&&(a.username=s.username),s.password&&(a.password=s.password);var n=JSON.stringify(a);s.socket.send(n)}},connectSuccess:function(t){var e=this;e.startPing.call(e),e.callbacks.connected.call(e,null,t)},connectFail:function(t){var e=this;e.callbacks.connected.call(e,1,t)},taskSuccess:function(t){var e=this;e.callbacks[t.task]&&(e.callbacks[t.task].call(e,null,t),delete e.callbacks[t.task],delete e.tasks[t.task])},taskFail:function(t){var e=this;e.callbacks[t.task]&&(e.callbacks[t.task].call(e,1,t),delete e.callbacks[t.task],delete e.tasks[t.task])},startPing:function(){var t=this;t.firePing.call(t),t.ping=setInterval(function(){t.firePing.call(t)},15e3)},firePing:function(){var t=this;if(t.socket&&1==t.socket.readyState){t.socket.send("1"),t.startPong.call(t);var e=[];for(var s in t.tasks)e.push([s,t.tasks[s].timestamp]);e.sort(function(t,e){return t[1]<e[1]?1:t[1]>e[1]?-1:0});for(var a=e.length;a--;){var n=t.tasks[e[a][0]];t.socket.send(n.data)}}},startPong:function(){var t=this;t.pong&&(clearTimeout(t.pong),t.pong=null),t.pong=setTimeout(function(){t.firePong.call(t)},5e3)},stopPong:function(){var t=this;t.pong&&(clearTimeout(t.pong),t.pong=null)},firePong:function(){self.socket.close()},writeAndTask:function(t,e){var s=this;if(s.socket&&1==s.socket.readyState){var a=Math.round((new Date).getTime()),n=t.type+"-"+s.generateUUID.call();t.task=n,s.callbacks[n]=e;var c={};c.timestamp=a,c.data=JSON.stringify(t),c.task=n,s.tasks[n]=c;var o=JSON.stringify(t);s.socket.send(o)}},generateUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,s="x"===t?e:3&e|8;return s.toString(16)})},socketConnected:function(t){this.callbacks.connected=t},socketDisconnected:function(t){this.callbacks.disconnected=t},socketReceivedDevice:function(t){this.callbacks.device=t},socketReceivedPost:function(t){this.callbacks.post=t}};